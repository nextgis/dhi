#!/usr/bin/env python
# -*- coding: utf-8 -*-

#******************************************************************************
#
# create_yearly_dhi.py
# ---------------------------------------------------------
# Create yearly DHI product
# More: http://github.com/nextgis/dhi
#
# Usage: 
#      create_yearly_dhi.py [-h] [-s SUFFIX] year input_folder output_folder
#      where:
#           -h              show this help message and exit
#           year            year
#           input_folder    input folder with TIFs
#           output_folder   where to store the result
#           suffix          suffix to end to resulting file name
# Example:
#      python create_yearly_dhi.py 2004 x:\MCD15A2\2003\tif-lai\ y:\dhi\global\lai\ -s lai
#
# Copyright (C) 2015 Maxim Dubinin (sim@gis-lab.info)
#
# This source is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free
# Software Foundation; either version 2 of the License, or (at your option)
# any later version.
#
# This code is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
#
# A copy of the GNU General Public License is available on the World Wide Web
# at <http://www.gnu.org/copyleft/gpl.html>. You can also obtain it by writing
# to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,
# MA 02111-1307, USA.
#
#******************************************************************************

import os
import sys
import glob
import time
import shutil
import argparse

parser = argparse.ArgumentParser()
parser.add_argument('year', help='Year')
parser.add_argument('input_folder', help='Input folder with TIFs')
parser.add_argument('output_folder', help='Where to store the result')
parser.add_argument('-s', '--suffix', help='suffix to end to resulting file name')
args = parser.parse_args()

def sanitize():
    if not args.input_folder.endswith('\\'): args.input_folder = args.input_folder + '\\'
    if not args.output_folder.endswith('\\'): args.output_folder = args.output_folder + '\\'
    
    return args.input_folder,args.output_folder

if __name__ == '__main__':
    id,od = sanitize()
    
    #prepare environment
    gisbase = os.environ['GISBASE'] = "c:/tools/NextGIS_QGIS/apps/grass/grass-6.4.4/"
    gisdbase = os.environ['GISDBASE'] = "e:/users/maxim/thematic/dhi/"
    location = "dhi_grass"
    mapset   = "PERMANENT"

    sys.path.append(os.path.join(gisbase, "etc", "python"))
     
    import grass.script as grass
    import grass.script.setup as gsetup
    gsetup.init(gisbase, gisdbase, location, mapset)

    year = args.year
    prefix = 'dhi'
    if not args.suffix: args.suffix = ''
    os.chdir(id)
    fn_out = prefix + '_' + year + '_' + args.suffix + '.tif'

    t = time.time()

    for f in glob.glob('*.tif'):
        grass.run_command('r.in.gdal', input=f, output=f.replace('.tif',''))
        
    t_import = time.time() - t

    #for f in glob.glob('*.tif'):
    #    grass.run_command('r.null', map=f.replace('.tif',''), setnull="249,250,251,252,253,254,255")
    #    
    t_nodata = time.time() - t - t_import

    result = ''
    p = grass.pipe_command('g.mlist', type = 'rast', quiet=True, pattern=year + '*')
    for line in p.stdout:
        result = result + ',' + line.replace('\n','')

    input_rast_list = result.strip(',')

    grass.run_command('r.series', input=input_rast_list, output='dh1_' + year + ',dh2_' + year + ',ave_' + year + ',std_' + year, method='sum,minimum,average,stddev')
    grass.mapcalc('dh3_' + year + ' = std_' + year + '/ave_' + year)
    t_calc = time.time() - t - t_import - t_nodata

    grass.run_command('i.group', group='rgb_group_' + year, input='dh1_' + year + ',dh2_' + year + ',dh3_' + year)
    grass.run_command('r.out.gdal', input='rgb_group_' + year, output=fn_out, type='Float32', createopt='PROFILE=BASELINE,INTERLEAVE=PIXEL,TFW=YES')
    shutil.move(fn_out,od + fn_out)
    shutil.move(fn_out.replace('.tif','.tfw'),od + fn_out.replace('.tif','.tfw'))
    shutil.move(fn_out + '.aux.xml',od + fn_out + '.aux.xml')
    cmd = "gdal_edit -a_srs \"EPSG:4326\" " + od + fn_out
    os.system(cmd)

    t_export = time.time() - t - t_import - t_nodata - t_calc

    print "Import: " + str(round(t_import, 4)) + ", Nodata: " + str(round(t_nodata, 4)) + ", Calculations: " + str(round(t_calc, 4)) + ", Export: " + str(round(t_export, 4))
